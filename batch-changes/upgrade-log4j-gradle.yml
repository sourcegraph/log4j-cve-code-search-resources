name: upgrade-log4j-v2.16-gradle
description: Upgrades log4j to a version not affected by [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) nor [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046)

# Find all repositories that use Gradle (and have build.gradle files). We intentionally don't
# restrict to only repositories whose Gradle files include log4j, because we want to fix instances
# where log4j is a transitive (indirect) dependency as well (and in those cases, there would not be
# any files mentioning log4j).
on:
  - repositoriesMatchingQuery: file:build.gradle NOT content:#upgrade-log4j-gradle-cve-2021-44228

# In each repository,
steps:
  - run: |
         set -e -o nounset -o pipefail

         # Run for all Gradle subprojects.
         PROJECTS=$(./gradlew -q projects | sed -n 's/.*--- Project '"'"'\([^ ]*\)'"'"'.*/\1/p' | sort)
         for proj in $PROJECTS
         do
            # Find vulnerable log4j dependency versions among all transitive dependencies.
            VULN_LOG4J_DEPS=$(./gradlew -q "$proj":dependencies | sed -n 's/.*--- \([^ ]*\).*/\1/p' | sort | uniq | grep -E '^org.apache.logging.log4j:.*:2\.(0|1|2|3|4|5|6|7|8|9|10|11|12|13|14|15)(\.[0-9]+)$')
            if [ -n "$VULN_LOG4J_DEPS" ]; then
                echo Vulnerable log4j dependencies found in Gradle subject "$proj":
                echo "$VULN_LOG4J_DEPS"
                echo

                # Inject a rule into the Gradle build file to force usage of a non-vulnerable log4j version.
                GRADLE_BUILD_FILE=$(./gradlew -q "$proj":properties | grep '^buildFile: ' | cut -d ' ' -f 2)

                # This marker tells us if the Gradle build file already has the build rule injected (so we
                # don't inject it twice).
                MARKER="#upgrade-log4j-gradle-cve-2021-44228"
                if grep -q "$MARKER" "$GRADLE_BUILD_FILE"; then
                    echo Not updating "$GRADLE_BUILD_FILE" because it already contains "$MARKER"
                else
                    cat <<EOF >> "$GRADLE_BUILD_FILE"

         // Force usage of log4j dependencies that are not vulnerable to CVE-2021-44228. $MARKER
         configurations.all {
           resolutionStrategy.eachDependency { details ->
             if (details.target.group == 'org.apache.logging.log4j' && details.target.version < '2.16.0') {
               details.useVersion '2.16.0'
               details.because 'CVE-2021-44228'
             }
           }
         }
         EOF
                    echo Updated "$GRADLE_BUILD_FILE"
                fi
                echo
            fi
         done
    container: openjdk:18-buster

# Describe the changeset (e.g., GitHub pull request) you want for each repository.
changesetTemplate:
  title: Upgrade log4j dependency (CVE-2021-44228, CVE-2021-45046)
  body: Upgrades log4j to a version not affected by [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) nor [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046)
  branch: batches/upgrade-log4j-v2.16-gradle
  commit:
    message: Upgrade log4j dependency (CVE-2021-44228, CVE-2021-45046)
  published: false
